{"ast":null,"code":"import { __decorate, __metadata, __values } from \"tslib\";\nimport { Component } from \"@angular/core\";\nimport { Router } from \"@angular/router\";\nimport * as JSZip from \"jszip\";\nimport { ToastrService } from \"ngx-toastr\";\nimport { AntiVerusService } from \"src/app/service/anti-verus.service\";\nimport { DossierService } from \"src/app/service/dossier.service\";\nimport { MembreService } from \"src/app/service/membre.service\";\nimport { WebSocketDossierService } from \"src/app/service/web-socket-dossier.service\";\nimport Swal from \"sweetalert2\";\nvar TablesComponent = /** @class */function () {\n  function TablesComponent(toastr, dossierService, antiVerusService, router, webSocketService, membreService) {\n    var _this = this;\n    this.toastr = toastr;\n    this.dossierService = dossierService;\n    this.antiVerusService = antiVerusService;\n    this.router = router;\n    this.webSocketService = webSocketService;\n    this.membreService = membreService;\n    this.zip = new JSZip();\n    this.formData = new FormData();\n    this.verus = true;\n    this.projetDos = [];\n    this.webSocketService.messageHandlingAddDos(null).subscribe(function (message) {\n      if (message.subscribe && message.subscribe.projetId == JSON.parse(localStorage.getItem('projet')).id) _this.projetDos.push(message.subscribe);\n    });\n    this.webSocketService.messageHandlingSupprimerDos(null).subscribe(function (message) {\n      console.log(message);\n      if (message.supprimer && _this.projetDos.find(function (dos) {\n        return dos.id == message.supprimer.id;\n      }) && message.supprimer.projetId == JSON.parse(localStorage.getItem('projet')).id) _this.projetDos.splice(_this.projetDos.indexOf(_this.projetDos.find(function (dos) {\n        return dos.id == message.supprimer.id;\n      })), 1);\n    });\n  }\n  TablesComponent.prototype.ngOnInit = function () {\n    var _this = this;\n    this.membre = this.membreService.getMembreFromToken();\n    this.folderName = \"\";\n    var projet = JSON.parse(localStorage.getItem('projet'));\n    this.dossierService.recupererDossierDeProjet(projet.id).subscribe(function (data) {\n      if (data) _this.projetDos = data;\n      console.log(data);\n    }, function (error) {});\n  };\n  TablesComponent.prototype.onFileChange = function (event) {\n    var e_1, _a;\n    var _this = this;\n    var files = event.target.files;\n    this.folderName = files[0].webkitRelativePath.split('/')[0];\n    var totalSize = 0;\n    for (var i = 0; i < files.length; i++) {\n      totalSize += files[i].size;\n    }\n    if (totalSize > 30000000) {\n      console.log(\"error\");\n      this.toastr.error(\"Ce fichier contient plus de 300MB\");\n      event.target.value = '';\n    } else {\n      var folderNameDiv = document.getElementById(\"folderName\");\n      var folderDiv = document.getElementById(\"folder\");\n      folderDiv.classList.add(\"has-files\");\n      folderNameDiv.innerHTML = \"Nom du dossier : \" + this.folderName;\n      try {\n        for (var files_1 = __values(files), files_1_1 = files_1.next(); !files_1_1.done; files_1_1 = files_1.next()) {\n          var file = files_1_1.value;\n          var path = file.webkitRelativePath.split(\"\".concat(this.folderName, \"/\"))[1];\n          this.zip.file(path, file);\n        }\n      } catch (e_1_1) {\n        e_1 = {\n          error: e_1_1\n        };\n      } finally {\n        try {\n          if (files_1_1 && !files_1_1.done && (_a = files_1.return)) _a.call(files_1);\n        } finally {\n          if (e_1) throw e_1.error;\n        }\n      }\n      this.antiVerusService.checkVerus(this.zip).then(function (response) {\n        _this.antiVerusService.getReport().subscribe(function (resultat) {\n          if (resultat.data.attributes.stats.malicious > 0) {\n            _this.toastr.error(\"Un virus a été détecté !! \\nAttention à ce que vous mettez dans l'application !\");\n            _this.reloadPage();\n          } else {\n            _this.toastr.success(\"Dossier sain.\");\n            _this.verus = false;\n          }\n        });\n      });\n    }\n  };\n  TablesComponent.prototype.reloadPage = function () {\n    var _this = this;\n    this.router.navigateByUrl('/', {\n      skipLocationChange: true\n    }).then(function () {\n      _this.router.navigate([_this.router.url]);\n    });\n  };\n  TablesComponent.prototype.uploadDos = function () {\n    var _this = this;\n    this.zip.generateAsync({\n      type: 'blob'\n    }).then(function (content) {\n      var formData = new FormData();\n      formData.append(\"compressedFile\", content, \"\".concat(_this.folderName, \".zip\"));\n      /** appel au service Dossier */\n      var dossier = {\n        projetId: JSON.parse(localStorage.getItem('projet')).id,\n        membreId: _this.membreService.getMembreFromToken().id,\n        donnees: formData,\n        nomDossier: _this.folderName\n      };\n      _this.dossierService.sauvegarderDossier(dossier).subscribe(function (data) {\n        if (data) _this.webSocketService.messageHandlingAddDos(data).subscribe(function (message) {\n          // afficher le message reçu dans la console\n          console.log(message);\n        }, function (err) {\n          console.error(err); // afficher les erreurs dans la console\n        }, function () {\n          console.log('WebSocket connection closed'); // afficher un message lorsque la connexion est fermée\n        });\n      }, function (error) {\n        _this.toastr.error(\"Vous avez déjà importé le même dossier !\");\n      });\n      /** end */\n    });\n  };\n\n  TablesComponent.prototype.supprimerDossier = function (dossier) {\n    var _this = this;\n    Swal.fire({\n      title: \"Clé correcte, vous êtes sûr de supprimer le dossier : \" + dossier.nomDossier + \" ?\",\n      icon: 'info',\n      showCancelButton: true,\n      confirmButtonColor: '#3085d6',\n      cancelButtonColor: '#d33',\n      confirmButtonText: 'Oui, Supprimer',\n      cancelButtonText: 'Annuler',\n      background: 'rgba(0,0,0,0.9)',\n      backdrop: 'rgba(0,0,0,0.4)',\n      allowOutsideClick: false,\n      allowEscapeKey: false,\n      allowEnterKey: false,\n      focusConfirm: false\n    }).then(function (result) {\n      if (result.isConfirmed) {\n        _this.dossierService.supprimerDos(dossier.id).subscribe(function (data) {\n          //this.projetDos.splice(this.projetDos.indexOf(this.projetDos.find(dos => dos.id == dossier.id)),1)\n          _this.webSocketService.messageHandlingSupprimerDos(dossier).subscribe(function (message) {\n            console.log(message);\n          });\n        }, function (error) {\n          Swal.fire('Erreur', 'Suppression impossible ', 'error');\n        });\n      }\n    });\n  };\n  TablesComponent = __decorate([Component({\n    selector: \"app-tables\",\n    templateUrl: \"tables.component.html\",\n    styleUrls: ['./tables.component.scss']\n  }), __metadata(\"design:paramtypes\", [ToastrService, DossierService, AntiVerusService, Router, WebSocketDossierService, MembreService])], TablesComponent);\n  return TablesComponent;\n}();\nexport { TablesComponent };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}